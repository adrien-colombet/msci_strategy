borderColor: 'rgb(255, 99, 132)',
                            borderDash: [5, 5],
                            data: []
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'month'
                            }
                        }
                    }
                }
            });
            
            const portfolioCtx = document.getElementById('portfolioChart').getContext('2d');
            portfolioChart = new Chart(portfolioCtx, {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: 'Portfolio Value',
                            borderColor: 'rgb(54, 162, 235)',
                            data: []
                        },
                        {
                            label: 'Total Invested',
                            borderColor: 'rgb(153, 102, 255)',
                            borderDash: [5, 5],
                            data: []
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'month'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Value (€)'
                            }
                        }
                    }
                }
            });
        }
        
        async function fetchETFData() {
            const ticker = document.getElementById('etfSelect').value;
            const maLength = document.getElementById('maLength').value;
            
            try {
                const response = await fetch('/fetch_etf_data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ ticker, ma_length: maLength }),
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch ETF data');
                }
                
                return await response.json();
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to fetch ETF data: ' + error.message);
                return null;
            }
        }
        
        async function runSimulation() {
            // Show loading spinner
            const spinner = document.getElementById('loadingSpinner');
            spinner.style.display = 'inline-block';
            
            try {
                // Gather form data
                const ticker = document.getElementById('etfSelect').value;
                const investment_amount = parseFloat(document.getElementById('investmentAmount').value);
                const start_date = document.getElementById('startDate').value;
                const ma_length = parseInt(document.getElementById('maLength').value);
                const use_ma_strategy = document.getElementById('useMAStrategy').checked;
                
                // Fetch ETF data and display price chart
                const etfData = await fetchETFData();
                if (!etfData) {
                    throw new Error('Failed to fetch ETF data');
                }
                
                updatePriceChart(etfData);
                
                // Run investment simulation
                const simulationResponse = await fetch('/simulate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        ticker,
                        investment_amount,
                        start_date,
                        frequency_months: 1,
                        ma_length,
                        use_ma_strategy
                    }),
                });
                
                if (!simulationResponse.ok) {
                    throw new Error('Failed to run simulation');
                }
                
                const simulationResults = await simulationResponse.json();
                updatePortfolioChart(simulationResults);
                updateResultsCard(simulationResults);
                
                // Show results card
                document.getElementById('resultsCard').style.display = 'block';
            } catch (error) {
                console.error('Error:', error);
                alert('Simulation failed: ' + error.message);
            } finally {
                // Hide loading spinner
                spinner.style.display = 'none';
            }
        }
        
        function updatePriceChart(data) {
            // Convert data to chart format
            const priceData = data.dates.map((date, i) => ({
                x: date,
                y: data.close[i]
            }));
            
            const maData = data.dates.map((date, i) => ({
                x: date,
                y: data.ma[i]
            }));
            
            // Update chart data
            priceChart.data.datasets[0].data = priceData;
            priceChart.data.datasets[1].data = maData;
            priceChart.update();
        }
        
        function updatePortfolioChart(results) {
            if (!results || !results.history) return;
            
            // Convert history to chart format
            const portfolioData = results.history.map(item => ({
                x: item.date,
                y: item.portfolio_value
            }));
            
            const investedData = results.history.map(item => ({
                x: item.date,
                y: item.total_invested
            }));
            
            // Update chart data
            portfolioChart.data.datasets[0].data = portfolioData;
            portfolioChart.data.datasets[1].data = investedData;
            portfolioChart.update();
        }
        
        function updateResultsCard(results) {
            if (!results || !results.investments || results.investments.length === 0) return;
            
            // Get the last investment record
            const lastInvestment = results.investments[results.investments.length - 1];
            
            // Update the results card
            document.getElementById('totalInvested').textContent = '€' + lastInvestment.total_invested.toFixed(2);
            document.getElementById('currentValue').textContent = '€' + lastInvestment.total_value.toFixed(2);
            
            const returnPercentage = ((lastInvestment.total_value / lastInvestment.total_invested) - 1) * 100;
            document.getElementById('totalReturn').textContent = returnPercentage.toFixed(2) + '%';
            
            document.getElementById('totalShares').textContent = lastInvestment.total_shares.toFixed(4);
            document.getElementById('cashBalance').textContent = '€' + lastInvestment.cash_balance?.toFixed(2) || '0.00';
        }
    </script>
</body>
</html>
